---
  name: Build and Push OR check-PR

  on:
    pull_request:
      branches:
        - main
    push:
      branches:
        - main
        - dev
      tags:
        - "*"
    workflow_dispatch:

  jobs:
    compile_sketch:
      name: Build ${{ matrix.board.env }}
      runs-on: ubuntu-latest
      strategy:
        fail-fast: false
        matrix:
          board:
            - { env: "xteink-x4" }

      steps:
          - uses: actions/checkout@v4
            with:
              repository: juicecultus/Launcher-X4

          - id: build
            name: setup Python
            uses: actions/setup-python@v2
            with:
              python-version: "3.13"

          - name: Install dependencies
            run: |
              pip install requests esptool

          - name: Install PlatformIO Core
            run: |
              pip install platformio

              if [[ "${{ github.ref_type }}" == "tag" ]]; then
                version=${{ github.ref_name }}
              else
                version="${GITHUB_SHA::7}"
              fi

              sed -i "s/-DLAUNCHER=/-DLAUNCHER='\"$version\"' ; /g" ./platformio.ini

          - name: Run Compile
            run: |
              platformio run -e ${{ matrix.board.env }}

          - name: Copy firmware to release name
            run: |
              cp .pio/build/${{ matrix.board.env }}/firmware.bin Launcher-X4.bin

          - name: Upload Artifacts
            uses: actions/upload-artifact@v4
            with:
              name: Launcher-X4
              path: Launcher-X4.bin
              retention-days: 5
              if-no-files-found: error

    post_compile_steps:
      name: Post-compile steps
      runs-on: ubuntu-latest
      needs: compile_sketch
      if: (github.event_name == 'push' || github.event_name == 'workflow_dispatch') || github.ref_type == 'tag'
      steps:
        - uses: actions/checkout@v4
          with:
            repository: juicecultus/Launcher-X4
            # WebPage branch no longer exists; use default branch for post steps.
            ref: main
            fetch-depth: 1

        - name: Download all artifacts
          uses: actions/download-artifact@v4
          with:
            path: ~/LauncherArtifacts

        - name: Move artifacts to the correct folders
          run: |
            set -x
            pwd
            mkdir -p artifacts
            cp -f ~/LauncherArtifacts/*/*.bin artifacts/Launcher-X4.bin
            tree

        - name: Compute next tag (0.1.x)
          id: next_tag
          uses: actions/github-script@v7
          with:
            script: |
              const tags = await github.paginate(github.rest.repos.listTags, {
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
              });
              const versions = tags
                .map(t => t.name)
                .filter(name => /^0\.1\.\d+$/.test(name))
                .map(name => Number(name.split('.')[2]))
                .filter(n => Number.isFinite(n));
              const nextPatch = versions.length ? Math.max(...versions) + 1 : 0;
              const nextTag = `0.1.${nextPatch}`;
              core.setOutput('tag', nextTag);

        - name: Create tag ref
          uses: actions/github-script@v7
          with:
            script: |
              const tag = '${{ steps.next_tag.outputs.tag }}';
              const ref = `refs/tags/${tag}`;
              await github.rest.git.createRef({
                owner: context.repo.owner,
                repo: context.repo.repo,
                ref,
                sha: process.env.GITHUB_SHA,
              });

        - name: Upload release asset
          uses: softprops/action-gh-release@v2
          with:
            name: Launcher Release ${{ steps.next_tag.outputs.tag }}
            tag_name: ${{ steps.next_tag.outputs.tag }}
            make_latest: true
            files: artifacts/Launcher-X4.bin
            fail_on_unmatched_files: false
            generate_release_notes: false
